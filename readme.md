# Требования к системе обработки входящей корреспонденции

## 1. Функциональные требования

### 1.1. Инжест входящих писем
Система должна уметь принимать письма из внешних источников и передавать их на обработку.
- Приём писем с полями: `from`, `to`, `subject`, `body`, `received_at`.
- Возможность загрузки писем через API.
- Постановка сообщений в очередь (Kafka) или прямое сохранение в БД.
- Сохранение оригинального текста письма.

### 1.2. Автоматическая классификация писем
Система должна автоматически определять категорию входящего письма.  
Поддерживаемые типы:
- complaint — жалоба/претензия
- info_request — запрос информации
- regulator — регуляторный запрос
- partnership — партнёрское предложение
- approval — запрос на согласование
- notification — уведомление

### 1.3. Извлечение ключевой информации
Из письма должны извлекаться структурированные данные:
- номер договора / счёта;
- суммы и финансовые показатели;
- сроки, требования, ограничения;
- ссылки на нормативные акты;
- намерение отправителя (intent);
- краткое саммари (2–3 предложения).

### 1.4. Расчёт срока ответа (SLA)
Система должна вычислять корректный срок ответа:
- базовый SLA по типу письма;
- указанный SLA (если есть);
- итоговая дата ответа (sla_date);
- уровень срочности: low / medium / high.

### 1.5. Хранение писем и их метаданных
Система должна сохранять:
- исходный текст письма;
- классификацию;
- дату ответа (SLA);
- извлечённые реквизиты;
- саммари;
- связи parent_id / child_id;
- статус обработки.

### 1.6. Генерация вариантов ответа
Система должна уметь формировать ответы:
- минимум три стиля ответа: официальный, деловой, клиентоориентированный;
- LLM учитывает текст письма, тип, реквизиты, сроки;
- ответы возвращаются в JSON и могут сохраняться в БД.

### 1.7. REST API
Основные методы:
- GET /mails — список писем;
- GET /mails/{id} — карточка письма;
- POST /mails/{id}/answers — генерация ответов;
- GET /mails/{id}/summary — саммари;
- POST /mails — приём нового письма.

### 1.8. Поддержка очередей (Kafka)
Система должна:
- публиковать письма в топик incoming-mails;
- иметь воркер, выполняющий LLM-обработку и запись в БД.

### 1.9. Отчётность и мониторинг
- количество писем по категориям;
- письма с истекающим SLA;
- логирование работы LLM.

## 2. Нефункциональные требования

### 2.1. Масштабируемость
- независимое масштабирование API, worker’ов, LLM-сервиса;
- использование Kafka как шины событий.

### 2.2. Надёжность
- Kafka — at-least-once;
- воркеры перезапускаемы без потерь;
- Postgres — устойчивое хранилище.

### 2.3. Производительность
- классификация + извлечение ≤ 1–2 сек;
- генерация ответа ≤ 2–4 сек.

### 2.4. Логирование и трассировка
- логирование всех операций;
- фиксация ошибок и ретраев.

### 2.5. Безопасность
- авторизация API;
- хранение писем без изменений;
- защита от утечек данных.

### 2.6. Конфигурируемость
- гибкие SLA;
- количество стилей ответов;
- правила классификации.

### 2.7. Простота развёртывания
- docker-compose (api, python svc, worker, postgres, kafka);
- локальный режим без Kafka.

### 2.8. Расширяемость
- новые категории писем;
- возможность заменить модель LLM;
- интеграция с почтовыми серверами.
